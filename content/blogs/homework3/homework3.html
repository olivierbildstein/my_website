

<div id="youth-risk-behavior-surveillance" class="section level1">
<h1>Youth Risk Behavior Surveillance</h1>
<p>Every two years, the Centers for Disease Control and Prevention conduct the <a href="https://www.cdc.gov/healthyyouth/data/yrbs/index.htm">Youth Risk Behavior Surveillance System (YRBSS)</a> survey, where it takes data from high schoolers (9th through 12th grade), to analyze health patterns. You will work with a selected group of variables from a random sample of observations during one of the years the YRBSS was conducted.</p>
<div id="load-the-data" class="section level2">
<h2>Load the data</h2>
<p>This data is part of the <code>openintro</code> textbook and we can load and inspect it. There are observations on 13 different variables, some categorical and some numerical. The meaning of each variable can be found by bringing up the help file:</p>
<p>?yrbss</p>
<pre class="r"><code>data(yrbss)
glimpse(yrbss)</code></pre>
<pre><code>## Rows: 13,583
## Columns: 13
## $ age                      &lt;int&gt; 14, 14, 15, 15, 15, 15, 15, 14, 15, 15, 15, …
## $ gender                   &lt;chr&gt; &quot;female&quot;, &quot;female&quot;, &quot;female&quot;, &quot;female&quot;, &quot;fem…
## $ grade                    &lt;chr&gt; &quot;9&quot;, &quot;9&quot;, &quot;9&quot;, &quot;9&quot;, &quot;9&quot;, &quot;9&quot;, &quot;9&quot;, &quot;9&quot;, &quot;9&quot;,…
## $ hispanic                 &lt;chr&gt; &quot;not&quot;, &quot;not&quot;, &quot;hispanic&quot;, &quot;not&quot;, &quot;not&quot;, &quot;not…
## $ race                     &lt;chr&gt; &quot;Black or African American&quot;, &quot;Black or Afric…
## $ height                   &lt;dbl&gt; NA, NA, 1.73, 1.60, 1.50, 1.57, 1.65, 1.88, …
## $ weight                   &lt;dbl&gt; NA, NA, 84.4, 55.8, 46.7, 67.1, 131.5, 71.2,…
## $ helmet_12m               &lt;chr&gt; &quot;never&quot;, &quot;never&quot;, &quot;never&quot;, &quot;never&quot;, &quot;did not…
## $ text_while_driving_30d   &lt;chr&gt; &quot;0&quot;, NA, &quot;30&quot;, &quot;0&quot;, &quot;did not drive&quot;, &quot;did no…
## $ physically_active_7d     &lt;int&gt; 4, 2, 7, 0, 2, 1, 4, 4, 5, 0, 0, 0, 4, 7, 7,…
## $ hours_tv_per_school_day  &lt;chr&gt; &quot;5+&quot;, &quot;5+&quot;, &quot;5+&quot;, &quot;2&quot;, &quot;3&quot;, &quot;5+&quot;, &quot;5+&quot;, &quot;5+&quot;…
## $ strength_training_7d     &lt;int&gt; 0, 0, 0, 0, 1, 0, 2, 0, 3, 0, 3, 0, 0, 7, 7,…
## $ school_night_hours_sleep &lt;chr&gt; &quot;8&quot;, &quot;6&quot;, &quot;&lt;5&quot;, &quot;6&quot;, &quot;9&quot;, &quot;8&quot;, &quot;9&quot;, &quot;6&quot;, &quot;&lt;5…</code></pre>
<p>Before you carry on with your analysis, it’s is always a good idea to check with <code>skimr::skim()</code> to get a feel for missing values, summary statistics of numerical variables, and a very rough histogram.</p>
</div>
<div id="exploratory-data-analysis" class="section level2">
<h2>Exploratory Data Analysis</h2>
<p>You will first start with analyzing the <code>weight</code> of participants in kilograms. Using visualization and summary statistics, describe the distribution of weights. How many observations are we missing weights from?</p>
<pre class="r"><code>skim(yrbss)</code></pre>
<table>
<caption>(#tab:eda_on_weight)Data summary</caption>
<tbody>
<tr class="odd">
<td align="left">Name</td>
<td align="left">yrbss</td>
</tr>
<tr class="even">
<td align="left">Number of rows</td>
<td align="left">13583</td>
</tr>
<tr class="odd">
<td align="left">Number of columns</td>
<td align="left">13</td>
</tr>
<tr class="even">
<td align="left">_______________________</td>
<td align="left"></td>
</tr>
<tr class="odd">
<td align="left">Column type frequency:</td>
<td align="left"></td>
</tr>
<tr class="even">
<td align="left">character</td>
<td align="left">8</td>
</tr>
<tr class="odd">
<td align="left">numeric</td>
<td align="left">5</td>
</tr>
<tr class="even">
<td align="left">________________________</td>
<td align="left"></td>
</tr>
<tr class="odd">
<td align="left">Group variables</td>
<td align="left">None</td>
</tr>
</tbody>
</table>
<p><strong>Variable type: character</strong></p>
<table>
<thead>
<tr class="header">
<th align="left">skim_variable</th>
<th align="right">n_missing</th>
<th align="right">complete_rate</th>
<th align="right">min</th>
<th align="right">max</th>
<th align="right">empty</th>
<th align="right">n_unique</th>
<th align="right">whitespace</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td align="left">gender</td>
<td align="right">12</td>
<td align="right">1.00</td>
<td align="right">4</td>
<td align="right">6</td>
<td align="right">0</td>
<td align="right">2</td>
<td align="right">0</td>
</tr>
<tr class="even">
<td align="left">grade</td>
<td align="right">79</td>
<td align="right">0.99</td>
<td align="right">1</td>
<td align="right">5</td>
<td align="right">0</td>
<td align="right">5</td>
<td align="right">0</td>
</tr>
<tr class="odd">
<td align="left">hispanic</td>
<td align="right">231</td>
<td align="right">0.98</td>
<td align="right">3</td>
<td align="right">8</td>
<td align="right">0</td>
<td align="right">2</td>
<td align="right">0</td>
</tr>
<tr class="even">
<td align="left">race</td>
<td align="right">2805</td>
<td align="right">0.79</td>
<td align="right">5</td>
<td align="right">41</td>
<td align="right">0</td>
<td align="right">5</td>
<td align="right">0</td>
</tr>
<tr class="odd">
<td align="left">helmet_12m</td>
<td align="right">311</td>
<td align="right">0.98</td>
<td align="right">5</td>
<td align="right">12</td>
<td align="right">0</td>
<td align="right">6</td>
<td align="right">0</td>
</tr>
<tr class="even">
<td align="left">text_while_driving_30d</td>
<td align="right">918</td>
<td align="right">0.93</td>
<td align="right">1</td>
<td align="right">13</td>
<td align="right">0</td>
<td align="right">8</td>
<td align="right">0</td>
</tr>
<tr class="odd">
<td align="left">hours_tv_per_school_day</td>
<td align="right">338</td>
<td align="right">0.98</td>
<td align="right">1</td>
<td align="right">12</td>
<td align="right">0</td>
<td align="right">7</td>
<td align="right">0</td>
</tr>
<tr class="even">
<td align="left">school_night_hours_sleep</td>
<td align="right">1248</td>
<td align="right">0.91</td>
<td align="right">1</td>
<td align="right">3</td>
<td align="right">0</td>
<td align="right">7</td>
<td align="right">0</td>
</tr>
</tbody>
</table>
<p><strong>Variable type: numeric</strong></p>
<table>
<thead>
<tr class="header">
<th align="left">skim_variable</th>
<th align="right">n_missing</th>
<th align="right">complete_rate</th>
<th align="right">mean</th>
<th align="right">sd</th>
<th align="right">p0</th>
<th align="right">p25</th>
<th align="right">p50</th>
<th align="right">p75</th>
<th align="right">p100</th>
<th align="left">hist</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td align="left">age</td>
<td align="right">77</td>
<td align="right">0.99</td>
<td align="right">16.16</td>
<td align="right">1.26</td>
<td align="right">12.00</td>
<td align="right">15.0</td>
<td align="right">16.00</td>
<td align="right">17.00</td>
<td align="right">18.00</td>
<td align="left">▁▂▅▅▇</td>
</tr>
<tr class="even">
<td align="left">height</td>
<td align="right">1004</td>
<td align="right">0.93</td>
<td align="right">1.69</td>
<td align="right">0.10</td>
<td align="right">1.27</td>
<td align="right">1.6</td>
<td align="right">1.68</td>
<td align="right">1.78</td>
<td align="right">2.11</td>
<td align="left">▁▅▇▃▁</td>
</tr>
<tr class="odd">
<td align="left">weight</td>
<td align="right">1004</td>
<td align="right">0.93</td>
<td align="right">67.91</td>
<td align="right">16.90</td>
<td align="right">29.94</td>
<td align="right">56.2</td>
<td align="right">64.41</td>
<td align="right">76.20</td>
<td align="right">180.99</td>
<td align="left">▆▇▂▁▁</td>
</tr>
<tr class="even">
<td align="left">physically_active_7d</td>
<td align="right">273</td>
<td align="right">0.98</td>
<td align="right">3.90</td>
<td align="right">2.56</td>
<td align="right">0.00</td>
<td align="right">2.0</td>
<td align="right">4.00</td>
<td align="right">7.00</td>
<td align="right">7.00</td>
<td align="left">▆▂▅▃▇</td>
</tr>
<tr class="odd">
<td align="left">strength_training_7d</td>
<td align="right">1176</td>
<td align="right">0.91</td>
<td align="right">2.95</td>
<td align="right">2.58</td>
<td align="right">0.00</td>
<td align="right">0.0</td>
<td align="right">3.00</td>
<td align="right">5.00</td>
<td align="right">7.00</td>
<td align="left">▇▂▅▂▅</td>
</tr>
</tbody>
</table>
<pre class="r"><code>#here we see that we have 12 missing Gender Values and 1004 for the weight variable

#filter for male - 6950 male
weight_m &lt;- yrbss %&gt;% 
  filter(gender==&quot;male&quot;)

#here we see that we have 6414 rows of weight that have a value different to na 
weight_m %&gt;%
  filter(!is.na(weight)) %&gt;% 
  summarise(n=n())</code></pre>
<pre><code>## # A tibble: 1 x 1
##       n
##   &lt;int&gt;
## 1  6414</code></pre>
<pre class="r"><code>#filter for female - 6621 female
weight_f &lt;- yrbss %&gt;% 
  filter(gender==&quot;female&quot;)

#here we see that we have 6165 rows of weight that have a value different to na
weight_f %&gt;%
  filter(!is.na(weight)) %&gt;% 
  summarise(n=n())</code></pre>
<pre><code>## # A tibble: 1 x 1
##       n
##   &lt;int&gt;
## 1  6165</code></pre>
<pre class="r"><code>#histo for all weight
ggplot(yrbss, aes(x=weight))+
  geom_histogram()+ #plot histogram
  labs(title=&quot;Fe/Male weight Distribution of 12579 Entries&quot;, #give names to title and X/Y axes
       x=&quot;Weight&quot;,
       y=&quot;Occurances&quot;)+
   theme_bw()+ #white theme
  NULL</code></pre>
<p><img src="homework3_files/figure-html/eda_on_weight-1.png" width="672" style="display: block; margin: auto;" /></p>
<pre class="r"><code>#histogram for male weight
ggplot(weight_m, aes(x=weight))+
  #geom_density()+
  geom_histogram()+
  labs(title=&quot;Male weight Distribution of 6414 Entries&quot;,
       x=&quot;Weight&quot;,
       y=&quot;Occurances&quot;)+
   theme_bw()+
  NULL</code></pre>
<p><img src="homework3_files/figure-html/eda_on_weight-2.png" width="672" style="display: block; margin: auto;" /></p>
<pre class="r"><code>#histo for female weight
ggplot(weight_f, aes(x=weight))+
  #geom_density()+
  geom_histogram()+
  labs(title=&quot;Female weight Distribution of 6165 Entries&quot;,
       x=&quot;Weight&quot;,
       y=&quot;Occurances&quot;)+
   theme_bw()+
  NULL</code></pre>
<p><img src="homework3_files/figure-html/eda_on_weight-3.png" width="672" style="display: block; margin: auto;" /></p>
<pre class="r"><code>#hist for weight after ethnicity 
#Remove NA
mean_weight &lt;- yrbss %&gt;% 
  filter(!is.na(weight)&amp;!is.na(race)) %&gt;% 
  group_by(race, gender) %&gt;% 
  summarise(mean_weight_group=mean(weight))

yrbss1 &lt;- yrbss %&gt;% 
  filter(!is.na(weight)&amp;!is.na(race))</code></pre>
<pre class="r"><code>yrbss_wide &lt;- left_join(x=yrbss1, y=mean_weight, by=c(&quot;race&quot;,&quot;gender&quot;), all=T )

glimpse(yrbss_wide)</code></pre>
<pre><code>## Rows: 10,052
## Columns: 14
## $ age                      &lt;int&gt; 15, 15, 15, 15, 15, 14, 15, 15, 15, 15, 15, …
## $ gender                   &lt;chr&gt; &quot;female&quot;, &quot;female&quot;, &quot;female&quot;, &quot;female&quot;, &quot;fem…
## $ grade                    &lt;chr&gt; &quot;9&quot;, &quot;9&quot;, &quot;9&quot;, &quot;9&quot;, &quot;9&quot;, &quot;9&quot;, &quot;9&quot;, &quot;10&quot;, &quot;9&quot;…
## $ hispanic                 &lt;chr&gt; &quot;hispanic&quot;, &quot;not&quot;, &quot;not&quot;, &quot;not&quot;, &quot;not&quot;, &quot;not…
## $ race                     &lt;chr&gt; &quot;Native Hawaiian or Other Pacific Islander&quot;,…
## $ height                   &lt;dbl&gt; 1.73, 1.60, 1.50, 1.57, 1.65, 1.88, 1.75, 1.…
## $ weight                   &lt;dbl&gt; 84.4, 55.8, 46.7, 67.1, 131.5, 71.2, 63.5, 9…
## $ helmet_12m               &lt;chr&gt; &quot;never&quot;, &quot;never&quot;, &quot;did not ride&quot;, &quot;did not r…
## $ text_while_driving_30d   &lt;chr&gt; &quot;30&quot;, &quot;0&quot;, &quot;did not drive&quot;, &quot;did not drive&quot;,…
## $ physically_active_7d     &lt;int&gt; 7, 0, 2, 1, 4, 4, 5, 0, 0, 0, 4, 7, 7, 7, 4,…
## $ hours_tv_per_school_day  &lt;chr&gt; &quot;5+&quot;, &quot;2&quot;, &quot;3&quot;, &quot;5+&quot;, &quot;5+&quot;, &quot;5+&quot;, &quot;5+&quot;, &quot;do …
## $ strength_training_7d     &lt;int&gt; 0, 0, 1, 0, 2, 0, 3, 0, 3, 0, 0, 7, 7, 7, 3,…
## $ school_night_hours_sleep &lt;chr&gt; &quot;&lt;5&quot;, &quot;6&quot;, &quot;9&quot;, &quot;8&quot;, &quot;9&quot;, &quot;6&quot;, &quot;&lt;5&quot;, &quot;&lt;5&quot;, &quot;…
## $ mean_weight_group        &lt;dbl&gt; 60.5, 65.1, 65.1, 65.1, 65.1, 73.8, 73.8, 73…</code></pre>
<pre class="r"><code>ggplot(yrbss1, aes(x=weight))+
  geom_histogram(aes(fill=gender))+
  labs(title=&quot;Weight Distribution after Race and Gender&quot;,
       x=&quot;Weight&quot;,
       y=&quot;Occurances&quot;) +
  facet_grid(race~gender, margins=F, scales=&quot;free_y&quot;, switch=&quot;y&quot;)+
  theme_minimal()+
  theme(strip.text.y = element_text(size = 8), #change font size
        legend.position=&quot;bottom&quot;) + #put legend down

  geom_vline(data = mean_weight, #add vertical lines to the graph
             aes(xintercept = mean_weight_group), 
             colour=&quot;red&quot;, 
             size=1)+
  scale_x_continuous(breaks=c(0,50,60,70,80,90,100,120,140,160,200))+
  #theme(strip.text.y = element_text(size=8)) +
  NULL</code></pre>
<p><img src="homework3_files/figure-html/eda_on_weight2-1.png" width="672" style="display: block; margin: auto;" /></p>
<p>Next, consider the possible relationship between a high schooler’s weight and their physical activity. Plotting the data is a useful first step because it helps us quickly visualize trends, identify strong associations, and develop research questions.</p>
<p>Let’s create a new variable <code>physical_3plus</code>, which will be <code>yes</code> if they are physically active for at least 3 days a week, and <code>no</code> otherwise.</p>
<pre class="r"><code>yrbss &lt;- yrbss %&gt;% 
  mutate(physical_3plus = ifelse(physically_active_7d &gt;= 3, &quot;yes&quot;, &quot;no&quot;))

yrbss1 &lt;- yrbss1 %&gt;% 
  mutate(physical_3plus = ifelse(physically_active_7d &gt;= 3, &quot;yes&quot;, &quot;no&quot;))

yrbss %&gt;% filter(!is.na(physical_3plus)) %&gt;% 
  group_by(physical_3plus) %&gt;% 
  summarise(count = n()) %&gt;% 
  mutate(prop= count/sum(count))</code></pre>
<pre><code>## # A tibble: 2 x 3
##   physical_3plus count  prop
##   &lt;chr&gt;          &lt;int&gt; &lt;dbl&gt;
## 1 no              4404 0.331
## 2 yes             8906 0.669</code></pre>
<p>Can you provide a 95% confidence interval for the population proportion of high schools that are <em>NOT</em> active 3 or more days per week?</p>
<pre class="r"><code>#add a new vairable for students doing less than 3 days a week sport (=once or twice per day)
yrbss &lt;- yrbss %&gt;% 
  mutate(physical_3minus = ifelse(physically_active_7d &lt; 3, &quot;yes&quot;, &quot;no&quot;))

#CI - Yes is for less than three days (once/twice per week) and no is more than twice a week
yrbss %&gt;%
  group_by(physical_3minus) %&gt;%
  filter(!is.na(physical_3minus)) %&gt;% 
  summarise(mean_weight = mean(weight, na.rm = TRUE),
            sd_weight = sd(weight, na.rm=TRUE),
            count = n(),
            se_weight = sd_weight/sqrt(count),
            t_critical = qt(0.975, count-1), 
            margin_of_error = t_critical * se_weight,
            lower = mean_weight - t_critical * se_weight,
            upper = mean_weight + t_critical * se_weight
            )</code></pre>
<pre><code>## # A tibble: 2 x 9
##   physical_3minus mean_weight sd_weight count se_weight t_critical
##   &lt;chr&gt;                 &lt;dbl&gt;     &lt;dbl&gt; &lt;int&gt;     &lt;dbl&gt;      &lt;dbl&gt;
## 1 no                     68.4      16.5  8906     0.175       1.96
## 2 yes                    66.7      17.6  4404     0.266       1.96
## # … with 3 more variables: margin_of_error &lt;dbl&gt;, lower &lt;dbl&gt;, upper &lt;dbl&gt;</code></pre>
<p>Make a boxplot of <code>physical_3plus</code> vs. <code>weight</code>. Is there a relationship between these two variables? What did you expect and why?</p>
<pre class="r"><code>#Is there a relationship between physical_3plus and weight after Race?
ggplot(subset(yrbss1, !is.na(physical_3plus)), aes(x=physical_3plus, y=weight, group=physical_3plus))+
  geom_boxplot(aes(fill=physical_3plus))+
  labs(title=&quot;Is there a significant Relationship b/w weight and physical activity after Race?&quot;,
       x=&quot;Active on more than 2 Day/week&quot;,
       y=&quot;Weight&quot;)+
  scale_y_continuous(breaks=c(50,60,70,80,90,100,150))+
  theme_minimal()+
  facet_grid(race~., margins=T, scales=&quot;free_y&quot;, switch=&quot;y&quot;)+
  NULL</code></pre>
<p><img src="homework3_files/figure-html/boxplot-1.png" width="672" style="display: block; margin: auto;" /></p>
<pre class="r"><code>#Is there a relationship between physical_3plus and weight after Gender?
ggplot(subset(yrbss1, !is.na(physical_3plus)), aes(x=physical_3plus, y=weight, group=physical_3plus))+
  geom_boxplot(aes(fill=physical_3plus))+
  labs(title=&quot;Is there a significant Relationship b/w weight and physical activity after Gender?&quot;,
       x=&quot;Active on more than 2 Day/week&quot;,
       y=&quot;Weight&quot;)+
  scale_y_continuous(breaks=c(50,60,70,80,90,100,150))+
  theme_minimal()+
  facet_grid(gender~., margins=T, scales=&quot;free_y&quot;, switch=&quot;y&quot;)+
  NULL</code></pre>
<p><img src="homework3_files/figure-html/boxplot-2.png" width="672" style="display: block; margin: auto;" /></p>
<pre class="r"><code>#Is there a relationship between physical_3plus and weight after Race and Gender?
ggplot(subset(yrbss1, !is.na(physical_3plus)), aes(x=physical_3plus, y=weight, group=physical_3plus))+
  geom_boxplot(aes(fill=physical_3plus))+
  labs(title=&quot;Is there a significant Relationship b/w weight and physical activity after Gender?&quot;,
       x=&quot;Active on more than 2 Day/week&quot;,
       y=&quot;Weight&quot;)+
  scale_y_continuous(breaks=c(50,60,70,80,90,100,150))+
  theme_minimal()+
  facet_grid(race~gender, margins=T, scales=&quot;free_y&quot;, switch=&quot;y&quot;)+
  NULL</code></pre>
<p><img src="homework3_files/figure-html/boxplot-3.png" width="672" style="display: block; margin: auto;" /></p>
<pre class="r"><code>#Relationship between physical_3plus and weight?
ggplot(subset(yrbss1, !is.na(physical_3plus)), aes(x=physical_3plus, y=weight, group=physical_3plus))+
  geom_boxplot(aes(fill=physical_3plus))+
  labs(title=&quot;Is there a significant Relationship b/w weight and physical activity?&quot;,
       x=&quot;Active on more than 2 Day/week&quot;,
       y=&quot;Weight&quot;)+
  scale_y_continuous(breaks=c(50,60,70,80,90,100,150))+
  theme_minimal()+
  NULL</code></pre>
<p><img src="homework3_files/figure-html/boxplot-4.png" width="672" style="display: block; margin: auto;" /></p>
</div>
<div id="confidence-interval" class="section level2">
<h2>Confidence Interval</h2>
<p>Boxplots show how the medians of the two distributions compare, but we can also compare the means of the distributions using either a confidence interval or a hypothesis test. Note that when we calculate the mean/SD, etc weight in these groups using the mean function, we must ignore any missing values by setting the <code>na.rm = TRUE</code>.</p>
<pre class="r"><code>yrbss %&gt;%
  group_by(physical_3plus) %&gt;%
  filter(!is.na(physical_3plus)) %&gt;% 
  summarise(mean_weight = mean(weight, na.rm = TRUE),
            sd_weight = sd(weight, na.rm=TRUE),
            count = n(),
            se_weight = sd_weight/sqrt(count),
            t_critical = qt(0.975, count-1), 
            margin_of_error = t_critical * se_weight,
            lower = mean_weight - t_critical * se_weight,
            upper = mean_weight + t_critical * se_weight
            )</code></pre>
<pre><code>## # A tibble: 2 x 9
##   physical_3plus mean_weight sd_weight count se_weight t_critical
##   &lt;chr&gt;                &lt;dbl&gt;     &lt;dbl&gt; &lt;int&gt;     &lt;dbl&gt;      &lt;dbl&gt;
## 1 no                    66.7      17.6  4404     0.266       1.96
## 2 yes                   68.4      16.5  8906     0.175       1.96
## # … with 3 more variables: margin_of_error &lt;dbl&gt;, lower &lt;dbl&gt;, upper &lt;dbl&gt;</code></pre>
<p>There is an observed difference in the means of about 1.77kg (68.44 - 66.67), and we notice that the two confidence intervals do not overlap. It seems that the difference is at least 95% statistically significant. Let us also conduct a hypothesis test.</p>
</div>
<div id="hypothesis-test-with-formula" class="section level2">
<h2>Hypothesis test with formula</h2>
<p>Write the null and alternative hypotheses for testing whether mean weights are different for those who exercise at least times a week and those who don’t.</p>
<p>HO: There is no significant difference between weights and exercisingthree times a week (difference of means = 0)
H1: There is a significant difference between weight and exercising three times a week (difference of means != 0)</p>
<pre class="r"><code>t.test(weight ~ physical_3plus, data = yrbss)</code></pre>
<pre><code>## 
##  Welch Two Sample t-test
## 
## data:  weight by physical_3plus
## t = -5, df = 7479, p-value = 9e-08
## alternative hypothesis: true difference in means is not equal to 0
## 95 percent confidence interval:
##  -2.42 -1.12
## sample estimates:
##  mean in group no mean in group yes 
##              66.7              68.4</code></pre>
<p>We reject the null hypothesis of means equal to zero, due to the very low p-value.</p>
</div>
<div id="hypothesis-test-with-infer" class="section level2">
<h2>Hypothesis test with <code>infer</code></h2>
<p>Next, we will introduce a new function, <code>hypothesize</code>, that falls into the infer workflow. You will use this method for conducting hypothesis tests.</p>
<p>But first, we need to initialize the test, which we will save as <code>obs_diff</code>.</p>
<pre class="r"><code>#calculating difference in means
obs_diff &lt;- yrbss %&gt;%
  specify(weight ~ physical_3plus) %&gt;%
  calculate(stat = &quot;diff in means&quot;, order = c(&quot;yes&quot;, &quot;no&quot;))</code></pre>
<p>Notice how you can use the functions specify and calculate again like you did for calculating confidence intervals. Here, though, the statistic you are searching for is the difference in means, with the order being yes - no != 0.</p>
<p>After you have initialized the test, you need to simulate the test on the null distribution, which we will save as null.</p>
<pre class="r"><code>#simulation of test on null-distribution to see whether null hypothesis is true 
#null distribution is  probability distribution of  test statistic when the null hypothesis is true
null_dist &lt;- yrbss %&gt;%
  specify(weight ~ physical_3plus) %&gt;%
  hypothesize(null = &quot;independence&quot;) %&gt;%
  generate(reps = 1000, type = &quot;permute&quot;) %&gt;%
  calculate(stat = &quot;diff in means&quot;, order = c(&quot;yes&quot;, &quot;no&quot;))</code></pre>
<p>Here, <code>hypothesize</code> is used to set the null hypothesis as a test for independence, i.e., that there is no difference between the two population means. In one sample cases, the null argument can be set to <em>point</em> to test a hypothesis relative to a point estimate.</p>
<p>Also, note that the <code>type</code> argument within generate is set to permute, which is the argument when generating a null distribution for a hypothesis test.</p>
<p>We can visualize this null distribution with the following code:</p>
<pre class="r"><code>ggplot(data = null_dist, aes(x = stat)) +
  geom_histogram()+
  theme_minimal()+
  labs(title = &quot;The Null Distribution of our test statistics&quot;,
       x=&quot;Values of Null Disribution&quot;,
       y=&quot;Occurences&quot;)+
  theme_minimal()</code></pre>
<p><img src="homework3_files/figure-html/unnamed-chunk-8-1.png" width="672" style="display: block; margin: auto;" /></p>
<p>Now that the test is initialized and the null distribution formed, we can visualise to see how many of these null permutations have a difference of at least <code>obs_stat</code> of 1.77?</p>
<p>We can also calculate the p-value for your hypothesis test using the function <code>infer::get_p_value()</code>.</p>
<pre class="r"><code>null_dist %&gt;% visualize() +
  shade_p_value(obs_stat = obs_diff, direction = &quot;two-sided&quot;, size=0.5)+
   labs(title = &quot;Significant Difference in the mean b/ Weight and Sports&quot;, subtitle = &quot;Observed difference in sample means marked in red&quot;, x=&quot;Difference of means of weight and people who do  sport more than twice a week&quot;, y = &quot;Count&quot;)+
  theme_bw()+
  theme(plot.title = element_text(size = 15, face = &quot;bold&quot;),
        plot.subtitle = element_text(size = 10),  
        axis.text = element_text(size = 10), 
        axis.title = element_text(size=10))</code></pre>
<p><img src="homework3_files/figure-html/unnamed-chunk-9-1.png" width="672" style="display: block; margin: auto;" /></p>
<pre class="r"><code>null_dist %&gt;%
  get_p_value(obs_stat = obs_diff, direction = &quot;two_sided&quot;)</code></pre>
<pre><code>## # A tibble: 1 x 1
##   p_value
##     &lt;dbl&gt;
## 1       0</code></pre>
<p>This the standard workflow for performing hypothesis tests.</p>
</div>
</div>
<div id="imdb-ratings-differences-between-directors" class="section level1">
<h1>IMDB ratings: Differences between directors</h1>
<p><img src="images/directors.png" width="100%" style="display: block; margin: auto;" /></p>
<p>Reproduction of the graph</p>
<pre class="r"><code>movies &lt;- read_csv(here::here(&quot;data&quot;, &quot;movies.csv&quot;))
glimpse(movies)</code></pre>
<pre><code>## Rows: 2,961
## Columns: 11
## $ title               &lt;chr&gt; &quot;Avatar&quot;, &quot;Titanic&quot;, &quot;Jurassic World&quot;, &quot;The Aveng…
## $ genre               &lt;chr&gt; &quot;Action&quot;, &quot;Drama&quot;, &quot;Action&quot;, &quot;Action&quot;, &quot;Action&quot;, …
## $ director            &lt;chr&gt; &quot;James Cameron&quot;, &quot;James Cameron&quot;, &quot;Colin Trevorro…
## $ year                &lt;dbl&gt; 2009, 1997, 2015, 2012, 2008, 1999, 1977, 2015, 2…
## $ duration            &lt;dbl&gt; 178, 194, 124, 173, 152, 136, 125, 141, 164, 93, …
## $ gross               &lt;dbl&gt; 7.61e+08, 6.59e+08, 6.52e+08, 6.23e+08, 5.33e+08,…
## $ budget              &lt;dbl&gt; 2.37e+08, 2.00e+08, 1.50e+08, 2.20e+08, 1.85e+08,…
## $ cast_facebook_likes &lt;dbl&gt; 4834, 45223, 8458, 87697, 57802, 37723, 13485, 92…
## $ votes               &lt;dbl&gt; 886204, 793059, 418214, 995415, 1676169, 534658, …
## $ reviews             &lt;dbl&gt; 3777, 2843, 1934, 2425, 5312, 3917, 1752, 1752, 3…
## $ rating              &lt;dbl&gt; 7.9, 7.7, 7.0, 8.1, 9.0, 6.5, 8.7, 7.5, 8.5, 7.2,…</code></pre>
<pre class="r"><code>Spielberg_Burton &lt;- movies %&gt;%
  filter(director %in% c(&quot;Steven Spielberg&quot;,&quot;Tim Burton&quot;))%&gt;%
  group_by(director)%&gt;%
  summarise(mean=mean(rating),
            count=n(),
            t_critical=qt(0.975,count-1),
            se = sd(rating)/sqrt(count),
            margin_of_error = t_critical*se,
            ci_low = mean - margin_of_error,
            ci_high = mean + margin_of_error)

ggplot(Spielberg_Burton,
       aes(x=mean,y=reorder(director,mean),
           colour = director))+
  geom_errorbar(width=0.1,
                aes(xmin=ci_low,xmax=ci_high),
                size=1.5)+
  geom_point(aes(x=mean),
             size = 3)+
  geom_rect(aes(xmin = max(ci_low),
                xmax=min(ci_high),
                ymin=-Inf,ymax=Inf),
            fill=&quot;gray&quot;,
            colour=&quot;gray&quot;,
            alpha=0.3)+
  theme_bw()+
    geom_text(aes(x=mean,
                  label=round(mean,digits=2)), 
              size = 5, 
              vjust = -1,
              colour=&quot;black&quot;)+
  geom_text(aes(x=ci_low,
                label=round(ci_low,digits=2)),
            size=4,
            vjust=-1,
            colour=&quot;black&quot;)+
  geom_text(aes(x=ci_high,
                label=round(ci_high,digits=2)), 
            size = 4, 
            vjust=-1, 
            colour=&quot;black&quot;)+
  labs(title=&quot;Do Spielberg and Burton have the same IMDB ratings?&quot;, 
       subtitle = &quot;95% confidence intervals overlap&quot;, 
       x=&quot;Mean IMDB Rating&quot;,
       y =&quot;&quot;)+
  theme(plot.title = element_text(size = 12, face = &quot;bold&quot;), 
        axis.text = element_text(size = 8), 
        axis.title.x = element_text(size=8),
        legend.position = &quot;none&quot;)</code></pre>
<p><img src="homework3_files/figure-html/reproduction_directors-1.png" width="672" style="display: block; margin: auto;" /></p>
<blockquote>
<p>Null hypothesis: Movies of Spielberg and Burton have the same mean IMDB ratings. Alternative hypothesis: Movies of Spielberg and Burton have different mean IMDB ratings. After conducting the t.test command, the t-statistic is 3 and corresponding p-value is 0.01, which is smaller than 0.025. The 95% confidence interval of the mean difference is between 0.16 and 1.13. Therefore, we reject the null and can conclude that the mean IMDB ratings of movies directed by Steven Spielberg and Tim Burton are not equal.</p>
</blockquote>
<pre class="r"><code>#t-test command
S_B_ratings&lt;- movies%&gt;%
  filter(director %in% c(&quot;Steven Spielberg&quot;, &quot;Tim Burton&quot;))%&gt;%
  select(director,rating)

  t.test(rating ~ director,
         mu=0,
         alt = &quot;two.sided&quot;,
         conf=0.95,
         data=S_B_ratings,
         var.eq=FALSE)</code></pre>
<pre><code>## 
##  Welch Two Sample t-test
## 
## data:  rating by director
## t = 3, df = 31, p-value = 0.01
## alternative hypothesis: true difference in means is not equal to 0
## 95 percent confidence interval:
##  0.16 1.13
## sample estimates:
## mean in group Steven Spielberg       mean in group Tim Burton 
##                           7.57                           6.93</code></pre>
<pre class="r"><code>#t-test using &quot;infer&quot; package
null_ratings &lt;- S_B_ratings %&gt;%
  specify(rating ~ director) %&gt;%
  hypothesize(null = &quot;independence&quot;) %&gt;%
  generate(reps = 1000, type = &quot;permute&quot;) %&gt;%
  calculate(stat = &quot;diff in means&quot;, order = c(&quot;Steven Spielberg&quot;, &quot;Tim Burton&quot;))


obs_mean_diff &lt;- S_B_ratings %&gt;%
  specify(rating ~ director) %&gt;%
  calculate(stat = &quot;diff in means&quot;, order = c(&quot;Steven Spielberg&quot;, &quot;Tim Burton&quot;))

null_ratings %&gt;% visualize() +
  shade_p_value(obs_stat = obs_mean_diff, direction = &quot;two-sided&quot;, size=0.5)+
   labs(title = &quot;Differences in Spielberg and Burton movie ratings in a world\n where there is really no difference&quot;, subtitle = &quot;Observed difference in sample means marked in red&quot;, x=&quot;Average ratings of Spielberg movies - Average ratings of Burton movies&quot;, y = &quot;Count&quot;)+
  theme_bw()+
  theme(plot.title = element_text(size = 15, face = &quot;bold&quot;),
        plot.subtitle = element_text(size = 10),  
        axis.text = element_text(size = 10), 
        axis.title = element_text(size=10))+
  #geom_rect(aes(xmin=0.642663,
   #             xmax = Inf, 
    #            ymin=-Inf,
     #           ymax=Inf), 
      #      fill = &quot;lightyellow&quot;, 
       #     colour = &quot;lightyellow&quot;, 
        #    alpha=0.05)+
  #geom_rect(aes(xmin=-Inf,
   #             xmax = -0.642663,
    #            ymin=-Inf,
     #           ymax=Inf), 
      #      fill = &quot;lightyellow&quot;, 
       #     colour = &quot;lightyellow&quot;, 
        #    alpha=0.05)+
NULL</code></pre>
<p><img src="homework3_files/figure-html/difference_ratings-1.png" width="672" style="display: block; margin: auto;" /></p>
</div>
<div id="omega-group-plc--pay-discrimination" class="section level1">
<h1>Omega Group plc- Pay Discrimination</h1>
<p>At the last board meeting of Omega Group Plc., the headquarters of a large multinational company, the issue was raised that women were being discriminated in the company, in the sense that the salaries were not the same for male and female executives. A quick analysis of a sample of 50 employees (of which 24 men and 26 women) revealed that the average salary for men was about 8,700 higher than for women. This seemed like a considerable difference, so it was decided that a further analysis of the company salaries was warranted.</p>
<p>You are asked to carry out the analysis. The objective is to find out whether there is indeed a significant difference between the salaries of men and women, and whether the difference is due to discrimination or whether it is based on another, possibly valid, determining factor.</p>
<div id="loading-the-data" class="section level2">
<h2>Loading the data</h2>
<pre class="r"><code>omega &lt;- read_csv(here::here(&quot;data&quot;, &quot;omega.csv&quot;))
glimpse(omega) # examine the data frame</code></pre>
<pre><code>## Rows: 50
## Columns: 3
## $ salary     &lt;dbl&gt; 81894, 69517, 68589, 74881, 65598, 76840, 78800, 70033, 63…
## $ gender     &lt;chr&gt; &quot;male&quot;, &quot;male&quot;, &quot;male&quot;, &quot;male&quot;, &quot;male&quot;, &quot;male&quot;, &quot;male&quot;, &quot;m…
## $ experience &lt;dbl&gt; 16, 25, 15, 33, 16, 19, 32, 34, 1, 44, 7, 14, 33, 19, 24, …</code></pre>
</div>
<div id="relationship-salary---gender" class="section level2">
<h2>Relationship Salary - Gender ?</h2>
<p>The data frame <code>omega</code> contains the salaries for the sample of 50 executives in the company. Can you conclude that there is a significant difference between the salaries of the male and female executives?</p>
<p>Note that you can perform different types of analyses, and check whether they all lead to the same conclusion</p>
<p>. Confidence intervals
. Hypothesis testing
. Correlation analysis
. Regression</p>
<p>Calculate summary statistics on salary by gender. Also, create and print a dataframe where, for each gender, you show the mean, SD, sample size, the t-critical, the SE, the margin of error, and the low/high endpoints of a 95% confidence interval</p>
<pre class="r"><code># Summary Statistics of salary by gender
mosaic::favstats (salary ~ gender, data=omega)</code></pre>
<pre><code>##   gender   min    Q1 median    Q3   max  mean   sd  n missing
## 1 female 47033 60338  64618 70033 78800 64543 7567 26       0
## 2   male 54768 68331  74675 78568 84576 73239 7463 24       0</code></pre>
<pre class="r"><code># Dataframe with two rows (male-female) and having as columns gender, mean, SD, sample size, 
salary_gender &lt;- omega %&gt;% 
  group_by(gender) %&gt;% # Make a distinction based on gender
  summarise(mean = mean(salary), # Calculate the salary mean
            standard_deviation = sd(salary), # Calculate the salary SD
            sample_size = count(gender)) # Calculate the sample size
salary_gender</code></pre>
<pre><code>## # A tibble: 2 x 4
##   gender   mean standard_deviation sample_size
##   &lt;chr&gt;   &lt;dbl&gt;              &lt;dbl&gt;       &lt;int&gt;
## 1 female 64543.              7567.          26
## 2 male   73239.              7463.          24</code></pre>
<pre class="r"><code># the t-critical value, the standard error, the margin of error

salary_gender &lt;- omega %&gt;% 
  group_by(gender) %&gt;% # Make a distinction based on gender
  summarise(standard_error = sd(salary) / sqrt(count(gender)), # Calculate the standard error via formula
            margin_error = 1.96 * sd(salary)) # Calculate the margin error via formula
salary_gender</code></pre>
<pre><code>## # A tibble: 2 x 3
##   gender standard_error margin_error
##   &lt;chr&gt;           &lt;dbl&gt;        &lt;dbl&gt;
## 1 female          1484.       14832.
## 2 male            1523.       14627.</code></pre>
<pre class="r"><code># and the low/high endpoints of a 95% confidence interval

salary_gender &lt;- omega %&gt;% 
  group_by(gender) %&gt;% # Make a distinction based on gender
  summarise(low_endpoint = mean(salary) - 1.96 * sd(salary) / 2, # Calculate low endpoint via formula
            high_endpoint = mean(salary) + 1.96 * sd(salary) / 2) # Calculate high endpoint via formula
salary_gender</code></pre>
<pre><code>## # A tibble: 2 x 3
##   gender low_endpoint high_endpoint
##   &lt;chr&gt;         &lt;dbl&gt;         &lt;dbl&gt;
## 1 female       57127.        71959.
## 2 male         65926.        80552.</code></pre>
<pre class="r"><code># Summary table

salary_gender &lt;- omega %&gt;% 
  group_by(gender) %&gt;% # Make a distinction based on gender
  summarise(mean = mean(salary), # Calculate the salary mean
            standard_deviation = sd(salary), # Calculate the salary SD
            sample_size = count(gender), # Calculate the sample size
            standard_error = standard_deviation/sqrt(sample_size), # Calculate the standard error via defined variable
            margin_error = 1.96 * standard_deviation, # Calculate the margin error via defined variable
            low_endpoint = mean - margin_error / 2, # Calculate low endpoint via defined variable
            high_endpoint = mean + margin_error / 2) # Calculate high endpoint via defined variable
salary_gender</code></pre>
<pre><code>## # A tibble: 2 x 8
##   gender   mean standard_deviat… sample_size standard_error margin_error
##   &lt;chr&gt;   &lt;dbl&gt;            &lt;dbl&gt;       &lt;int&gt;          &lt;dbl&gt;        &lt;dbl&gt;
## 1 female 64543.            7567.          26          1484.       14832.
## 2 male   73239.            7463.          24          1523.       14627.
## # … with 2 more variables: low_endpoint &lt;dbl&gt;, high_endpoint &lt;dbl&gt;</code></pre>
<blockquote>
<p>What can you conclude from your analysis? A couple of sentences would be enough</p>
</blockquote>
<blockquote>
<p>On average, women have a lower salary than men by 8696 dollars. In the 68% (1) and 95% (2) confidence interval, the distribution of women salaries tends to be more spread out than men, as both women standard deviation (1) and margin error (2) are higher than men’. However this analysis doesn’t enable to conclude if the salary descripencies are justified or not. To do so, we should look at the experience years.</p>
</blockquote>
<p>You can also run a hypothesis testing, assuming as a null hypothesis that the mean difference in salaries is zero, or that, on average, men and women make the same amount of money. You should tun your hypothesis testing using <code>t.test()</code> and with the simulation method from the <code>infer</code> package.</p>
<pre class="r"><code># hypothesis testing using t.test() 
salary_gender_test &lt;- t.test(omega$salary,
                       alternative = c(&quot;two.sided&quot;),
                       mu = 0, paired = FALSE, var.equal = FALSE,
                       conf.level = 0.95)
salary_gender</code></pre>
<pre><code>## # A tibble: 2 x 8
##   gender   mean standard_deviat… sample_size standard_error margin_error
##   &lt;chr&gt;   &lt;dbl&gt;            &lt;dbl&gt;       &lt;int&gt;          &lt;dbl&gt;        &lt;dbl&gt;
## 1 female 64543.            7567.          26          1484.       14832.
## 2 male   73239.            7463.          24          1523.       14627.
## # … with 2 more variables: low_endpoint &lt;dbl&gt;, high_endpoint &lt;dbl&gt;</code></pre>
<pre class="r"><code># hypothesis testing using infer package</code></pre>
<blockquote>
<p>What can you conclude from your analysis? A couple of sentences would be enough</p>
</blockquote>
</div>
<div id="relationship-experience---gender" class="section level2">
<h2>Relationship Experience - Gender?</h2>
<p>At the board meeting, someone raised the issue that there was indeed a substantial difference between male and female salaries, but that this was attributable to other reasons such as differences in experience. A questionnaire send out to the 50 executives in the sample reveals that the average experience of the men is approximately 21 years, whereas the women only have about 7 years experience on average (see table below).</p>
<pre class="r"><code># Summary Statistics of salary by gender
favstats (experience ~ gender, data=omega)</code></pre>
<pre><code>##   gender min    Q1 median   Q3 max  mean    sd  n missing
## 1 female   0  0.25    3.0 14.0  29  7.38  8.51 26       0
## 2   male   1 15.75   19.5 31.2  44 21.12 10.92 24       0</code></pre>
<p>Based on this evidence, can you conclude that there is a significant difference between the experience of the male and female executives? Perform similar analyses as in the previous section. Does your conclusion validate or endanger your conclusion about the difference in male and female salaries?</p>
<blockquote>
<p>Based on this evidence</p>
</blockquote>
</div>
<div id="relationship-salary---experience" class="section level2">
<h2>Relationship Salary - Experience ?</h2>
<p>Someone at the meeting argues that clearly, a more thorough analysis of the relationship between salary and experience is required before any conclusion can be drawn about whether there is any gender-based salary discrimination in the company.</p>
<p>Analyse the relationship between salary and experience. Draw a scatterplot to visually inspect the data.</p>
<pre class="r"><code>omega &lt;- read_csv(here::here(&quot;data&quot;, &quot;omega.csv&quot;))
salary_gender &lt;- omega %&gt;% 
  group_by(gender) %&gt;% 
  ggplot(aes(x = experience, y = salary, group=gender, color=gender)) +
            scale_color_manual(values=c(male=&quot;blue&quot;, female=&quot;red&quot;)) +
            geom_point() +
            geom_smooth(se=FALSE) +
            labs(x=&quot;Years of experience&quot;, # x-axis title
            y=&quot;Yearly salary&quot;, # y-axis title
            color=&quot;Gender trend line&quot;,
            main=&quot;Enhanced Scatter Plot&quot;) # Main title
salary_gender</code></pre>
<p><img src="homework3_files/figure-html/salary_exp_scatter-1.png" width="672" style="display: block; margin: auto;" /></p>
</div>
<div id="check-correlations-between-the-data" class="section level2">
<h2>Check correlations between the data</h2>
<p>You can use <code>GGally:ggpairs()</code> to create a scatterplot and correlation matrix. Essentially, we change the order our variables will appear in and have the dependent variable (Y), salary, as last in our list. We then pipe the dataframe to <code>ggpairs()</code> with <code>aes</code> arguments to colour by <code>gender</code> and make ths plots somewhat transparent (<code>alpha  = 0.3</code>).</p>
<pre class="r"><code>omega %&gt;% 
  select(gender, experience, salary) %&gt;% #order variables they will appear in ggpairs()
  ggpairs(aes(colour=gender, alpha = 0.3))+
  theme_bw()</code></pre>
<p><img src="homework3_files/figure-html/ggpairs-1.png" width="672" style="display: block; margin: auto;" /></p>
<blockquote>
<p>Look at the salary vs experience scatterplot. What can you infer from this plot? Explain in a couple of sentences</p>
</blockquote>
<blockquote>
<p>Thanks to the salary vs experience scatterplot (but also the trend lines drawn in the previous section), we can infer that there are no strong evidence that for an equivalent number of experiences years, women earn less than man. Indeed from 0 to 9 years of experience, women actually make more money than men - but after 10 years of experience men tend to earn more.
In other words, we cannot really draw a conclusion from this dataset concerning gender inequality. That being said, a bigger population may enable stronger convictions.</p>
</blockquote>
</div>
</div>
<div id="challenge-1-yield-curve-inversion" class="section level1">
<h1>Challenge 1: Yield Curve inversion</h1>
<p>Every so often, we hear warnings from commentators on the “inverted yield curve” and its predictive power with respect to recessions. An explainer what a <a href="https://www.reuters.com/article/us-usa-economy-yieldcurve-explainer/explainer-what-is-an-inverted-yield-curve-idUSKBN1O50GA">inverted yield curve is can be found here</a>. If you’d rather listen to something, here is a great podcast from <a href="https://www.podbean.com/media/share/dir-4zgj9-6aefd11">NPR on yield curve indicators</a></p>
<p>In addition, many articles and commentators think that, e.g., <a href="https://www.bloomberg.com/news/articles/2019-08-14/u-k-yield-curve-inverts-for-first-time-since-financial-crisis"><em>Yield curve inversion is viewed as a harbinger of recession</em></a>. One can always doubt whether inversions are truly a harbinger of recessions, and <a href="https://twitter.com/5_min_macro/status/1161627360946511873">use the attached parable on yield curve inversions</a>.</p>
<p><img src="images/yield_curve_parable.jpg" width="100%" style="display: block; margin: auto;" /></p>
<p>In our case we will look at US data and use the <a href="https://fred.stlouisfed.org/">FRED database</a> to download historical yield curve rates, and plot the yield curves since 1999 to see when the yield curves flatten. If you want to know more, a very nice article that explains the <a href="https://fredblog.stlouisfed.org/2018/10/the-data-behind-the-fear-of-yield-curve-inversions/">yield curve is and its inversion can be found here</a>. At the end of this chllenge you should produce this chart</p>
<p><img src="images/yield_curve_challenge.png" width="100%" style="display: block; margin: auto;" /></p>
<p>First, we will use the <code>tidyquant</code> package to download monthly rates for different durations.</p>
<pre class="r"><code># Get a list of FRED codes for US rates and US yield curve; choose monthly frequency
# to see, eg., the 3-month T-bill https://fred.stlouisfed.org/series/TB3MS
tickers &lt;- c(&#39;TB3MS&#39;, # 3-month Treasury bill (or T-bill)
             &#39;TB6MS&#39;, # 6-month
             &#39;GS1&#39;,   # 1-year
             &#39;GS2&#39;,   # 2-year, etc....
             &#39;GS3&#39;,
             &#39;GS5&#39;,
             &#39;GS7&#39;,
             &#39;GS10&#39;,
             &#39;GS20&#39;,
             &#39;GS30&#39;)  #.... all the way to the 30-year rate

# Turn  FRED codes to human readable variables
myvars &lt;- c(&#39;3-Month Treasury Bill&#39;,
            &#39;6-Month Treasury Bill&#39;,
            &#39;1-Year Treasury Rate&#39;,
            &#39;2-Year Treasury Rate&#39;,
            &#39;3-Year Treasury Rate&#39;,
            &#39;5-Year Treasury Rate&#39;,
            &#39;7-Year Treasury Rate&#39;,
            &#39;10-Year Treasury Rate&#39;,
            &#39;20-Year Treasury Rate&#39;,
            &#39;30-Year Treasury Rate&#39;)

maturity &lt;- c(&#39;3m&#39;, &#39;6m&#39;, &#39;1y&#39;, &#39;2y&#39;,&#39;3y&#39;,&#39;5y&#39;,&#39;7y&#39;,&#39;10y&#39;,&#39;20y&#39;,&#39;30y&#39;)

# by default R will sort these maturities alphabetically; but since we want
# to keep them in that exact order, we recast maturity as a factor 
# or categorical variable, with the levels defined as we want
maturity &lt;- factor(maturity, levels = maturity)

# Create a lookup dataset
mylookup&lt;-data.frame(symbol=tickers,var=myvars, maturity=maturity)
# Take a look:
mylookup %&gt;% 
  knitr::kable()</code></pre>
<table>
<thead>
<tr class="header">
<th align="left">symbol</th>
<th align="left">var</th>
<th align="left">maturity</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td align="left">TB3MS</td>
<td align="left">3-Month Treasury Bill</td>
<td align="left">3m</td>
</tr>
<tr class="even">
<td align="left">TB6MS</td>
<td align="left">6-Month Treasury Bill</td>
<td align="left">6m</td>
</tr>
<tr class="odd">
<td align="left">GS1</td>
<td align="left">1-Year Treasury Rate</td>
<td align="left">1y</td>
</tr>
<tr class="even">
<td align="left">GS2</td>
<td align="left">2-Year Treasury Rate</td>
<td align="left">2y</td>
</tr>
<tr class="odd">
<td align="left">GS3</td>
<td align="left">3-Year Treasury Rate</td>
<td align="left">3y</td>
</tr>
<tr class="even">
<td align="left">GS5</td>
<td align="left">5-Year Treasury Rate</td>
<td align="left">5y</td>
</tr>
<tr class="odd">
<td align="left">GS7</td>
<td align="left">7-Year Treasury Rate</td>
<td align="left">7y</td>
</tr>
<tr class="even">
<td align="left">GS10</td>
<td align="left">10-Year Treasury Rate</td>
<td align="left">10y</td>
</tr>
<tr class="odd">
<td align="left">GS20</td>
<td align="left">20-Year Treasury Rate</td>
<td align="left">20y</td>
</tr>
<tr class="even">
<td align="left">GS30</td>
<td align="left">30-Year Treasury Rate</td>
<td align="left">30y</td>
</tr>
</tbody>
</table>
<pre class="r"><code>df &lt;- tickers %&gt;% tidyquant::tq_get(get=&quot;economic.data&quot;, 
                   from=&quot;1960-01-01&quot;)   # start from January 1960

glimpse(df)</code></pre>
<pre><code>## Rows: 6,774
## Columns: 3
## $ symbol &lt;chr&gt; &quot;TB3MS&quot;, &quot;TB3MS&quot;, &quot;TB3MS&quot;, &quot;TB3MS&quot;, &quot;TB3MS&quot;, &quot;TB3MS&quot;, &quot;TB3MS&quot;,…
## $ date   &lt;date&gt; 1960-01-01, 1960-02-01, 1960-03-01, 1960-04-01, 1960-05-01, 1…
## $ price  &lt;dbl&gt; 4.35, 3.96, 3.31, 3.23, 3.29, 2.46, 2.30, 2.30, 2.48, 2.30, 2.…</code></pre>
<p>Our dataframe <code>df</code> has three columns (variables):</p>
<ul>
<li><code>symbol</code>: the FRED database ticker symbol</li>
<li><code>date</code>: already a date object</li>
<li><code>price</code>: the actual yield on that date</li>
</ul>
<p>The first thing would be to join this dataframe <code>df</code> with the dataframe <code>mylookup</code> so we have a more readable version of maturities, durations, etc.</p>
<pre class="r"><code>yield_curve &lt;-left_join(df,mylookup,by=&quot;symbol&quot;) </code></pre>
<div id="plotting-the-yield-curve" class="section level2">
<h2>Plotting the yield curve</h2>
<p>This may seem long but it should be easy to produce the following three plots</p>
<div id="yields-on-us-rates-by-duration-since-1960" class="section level3">
<h3>Yields on US rates by duration since 1960</h3>
<p><img src="images/yield_curve1.png" width="100%" style="display: block; margin: auto;" /></p>
<pre class="r"><code>#Plotting the graph with years on the x-axis and yields on the y-axis
ggplot(yield_curve, aes(x = date, y = price, color = maturity)) +
#Facet_wrapping by maturity and var since the levels of maturity are ordered
    facet_wrap(maturity ~ var, ncol = 2) + 
#Choosing the plot type to be a line graph
    geom_line() +
#Black and white theme
    theme_bw() +
#Setting the x-axis labels to be in date format in years
    scale_x_date(labels=date_format(&quot;%Y&quot;)) +
#Removing legend and bolding plot title
    theme(legend.position = &quot;none&quot;, plot.title = element_text(face = &quot;bold&quot;)) +
#Setting plot and axis titiles
    labs(y = &#39;%&#39;, title = &#39;Yields on U.S. Treasury rates since 1960&#39;, caption = &quot;Source: St. Louis Federal Reserve Economic Database (FRED)&quot;, x = &quot;&quot;) </code></pre>
<p><img src="homework3_files/figure-html/yield_curve_1_plot_-1.png" width="768" style="display: block; margin: auto;" /></p>
</div>
<div id="monthly-yields-on-us-rates-by-duration-since-1999-on-a-year-by-year-basis" class="section level3">
<h3>Monthly yields on US rates by duration since 1999 on a year-by-year basis</h3>
<p><img src="images/yield_curve2.png" width="600" style="display: block; margin: auto;" /></p>
<pre class="r"><code>#Creating new data frame with years &gt;= 1999 and new year and month variables
yield_curve_with_years &lt;- yield_curve %&gt;% 
  filter(date&gt;=&quot;1999-01-01&quot;) %&gt;% 
   mutate(year = year(date), month = month(date))
    
#Plotting the graph with the different maturities on x-axis, yields on y-axis and grouping the yields by month
ggplot(yield_curve_with_years, aes(x = maturity, y = price, color = year, group = month)) +
#Facet wrap the plot by year
    facet_wrap(~year, ncol = 4) +
#Choosing the plot to be a line graph 
    geom_line() +
#Choosing a black and white theme
    theme_bw() +
#Removing plot legend
    theme(legend.position = &quot;none&quot;) +
#Setting plot labels
    labs(y = &#39;Yield (%)&#39;, title = &#39;US Yield Curve&#39;, caption = &quot;Source: St. Louis Federal Reserve Economic Database (FRED)&quot;, x = &quot;Maturity&quot;) +
#Bolding plot title
    theme(plot.title = element_text(face = &quot;bold&quot;))</code></pre>
<p><img src="homework3_files/figure-html/yield_curve_2_plot2-1.png" width="672" style="display: block; margin: auto;" /></p>
</div>
<div id="month-and-10-year-yields-since-1999" class="section level3">
<h3>3-month and 10-year yields since 1999</h3>
<p><img src="images/yield_curve3.png" width="100%" style="display: block; margin: auto;" /></p>
<pre class="r"><code>#Creating new data frame with only 3m Treasury Bill and 10y Treasury Note, and years since 1999
yield_curve_3m_10m &lt;- yield_curve %&gt;% 
  filter(date&gt;=&quot;1999-01-01&quot;, (maturity == &quot;3m&quot; | maturity == &quot;10y&quot;))

#Plotting graph with date on the x-axis and yields on the y-axis, colors grouped by var
ggplot(yield_curve_3m_10m, aes(x = date, y = price, color = var)) +
#Choosing plot to be a line graph   
    geom_line() +
#Choosing black and white theme   
    theme_bw() +
#Removing legend title and bolding plot title
    theme(legend.title = element_blank(), plot.title = element_text(face = &quot;bold&quot;)) +
#Setting plot and axis titles
    labs(y = &#39;%&#39;, title = &#39;Yields on 3-month and 10-year US Treasury rates since 1999&#39;, 
         caption = &quot;Source: St. Louis Federal Reserve Economic Database (FRED)&quot;, x = &quot;&quot;) +
#Setting x-axis labels to be in 5 year increments
    scale_x_date(date_breaks=&quot;5 years&quot;,labels=date_format(&quot;%Y&quot;), limits = c(as.Date(&quot;1999-01-01&quot;),NA))</code></pre>
<p><img src="homework3_files/figure-html/yield_curve_3_plot-1.png" width="100%" style="display: block; margin: auto;" /></p>
<p>According to <a href="https://en.wikipedia.org/wiki/List_of_recessions_in_the_United_States">Wikipedia’s list of recession in the United States</a>, since 1999 there have been two recession in the US: between Mar 2001–Nov 2001 and between Dec 2007–June 2009. Does the yield curve seem to flatten before these recessions? Can a yield curve flattening really mean a recession is coming in the US? Since 1999, when did short-term (3 months) yield more than longer term (10 years) debt?</p>
<p>Besides calculating the spread (10year - 3months), there are a few things we need to do to produce our final plot</p>
<ol style="list-style-type: decimal">
<li>Setup data for US recessions</li>
<li>Superimpose recessions as the grey areas in our plot</li>
<li>Plot the spread between 30 years and 3 months as a blue/red ribbon, based on whether the spread is positive (blue) or negative(red)</li>
</ol>
<ul>
<li>For the first, the code below creates a dataframe with all US recessions since 1946</li>
</ul>
<pre class="r"><code># get US recession dates after 1946 from Wikipedia 
# https://en.wikipedia.org/wiki/List_of_recessions_in_the_United_States

recessions &lt;- tibble(
  from = c(&quot;1948-11-01&quot;, &quot;1953-07-01&quot;, &quot;1957-08-01&quot;, &quot;1960-04-01&quot;, &quot;1969-12-01&quot;, &quot;1973-11-01&quot;, &quot;1980-01-01&quot;,&quot;1981-07-01&quot;, &quot;1990-07-01&quot;, &quot;2001-03-01&quot;, &quot;2007-12-01&quot;),  
  to = c(&quot;1949-10-01&quot;, &quot;1954-05-01&quot;, &quot;1958-04-01&quot;, &quot;1961-02-01&quot;, &quot;1970-11-01&quot;, &quot;1975-03-01&quot;, &quot;1980-07-01&quot;, &quot;1982-11-01&quot;, &quot;1991-03-01&quot;, &quot;2001-11-01&quot;, &quot;2009-06-01&quot;) 
  )  %&gt;% 
  mutate(From = ymd(from), 
         To=ymd(to),
         duration_days = To-From)

recessions</code></pre>
<pre><code>## # A tibble: 11 x 5
##    from       to         From       To         duration_days
##    &lt;chr&gt;      &lt;chr&gt;      &lt;date&gt;     &lt;date&gt;     &lt;drtn&gt;       
##  1 1948-11-01 1949-10-01 1948-11-01 1949-10-01 334 days     
##  2 1953-07-01 1954-05-01 1953-07-01 1954-05-01 304 days     
##  3 1957-08-01 1958-04-01 1957-08-01 1958-04-01 243 days     
##  4 1960-04-01 1961-02-01 1960-04-01 1961-02-01 306 days     
##  5 1969-12-01 1970-11-01 1969-12-01 1970-11-01 335 days     
##  6 1973-11-01 1975-03-01 1973-11-01 1975-03-01 485 days     
##  7 1980-01-01 1980-07-01 1980-01-01 1980-07-01 182 days     
##  8 1981-07-01 1982-11-01 1981-07-01 1982-11-01 488 days     
##  9 1990-07-01 1991-03-01 1990-07-01 1991-03-01 243 days     
## 10 2001-03-01 2001-11-01 2001-03-01 2001-11-01 245 days     
## 11 2007-12-01 2009-06-01 2007-12-01 2009-06-01 548 days</code></pre>
<ul>
<li>To add the grey shaded areas corresponding to recessions, we use <code>geom_rect()</code></li>
<li>to colour the ribbons blue/red we must see whether the spread is positive or negative and then use <code>geom_ribbon()</code>. You should be familiar with this from last week’s homework on the excess weekly/monthly rentals of Santander Bikes in London.</li>
</ul>
<p><img src="images/yield_curve_challenge.png" width="100%" style="display: block; margin: auto;" /></p>
<pre class="r"><code>#Creating new data frame with only 3m and 10y maturities, pivoting wider and creating a new variable difference
yield_curve_final &lt;- yield_curve %&gt;% 
  filter((maturity == &quot;3m&quot; | maturity == &quot;10y&quot;)) %&gt;% 
  select(c(&quot;date&quot;,&quot;price&quot;,&quot;var&quot;)) %&gt;%
  pivot_wider(names_from = &quot;var&quot;, values_from = &quot;price&quot;) %&gt;% 
  mutate(difference=`10-Year Treasury Rate` - `3-Month Treasury Bill`)

#Plotting graph with date on the x-axis and the difference on the y-axis
ggplot(yield_curve_final, aes(x=date, y=difference)) +
#Choosing plot to be a line graph  
  geom_line() +
#Creating title and labels for graph
    labs(y = &#39;Difference (10 year-3 month) yield in %&#39;, title = &#39;Yield Curve Inversion: 10-year minus 3-month U.S. Treasury Rates&#39;, 
      caption = &quot;Source: St. Louis Federal Reserve Economic Database (FRED)&quot;, 
      subtitle = &quot;Difference in % points, monthly averages. \nShaded areas correspond to recessions&quot;, x=&quot;&quot;) +
#Selecting black and white theme
  theme_bw() +
#Fixing x-axis labels and limits
  scale_x_date(date_breaks=&quot;2 years&quot;,labels=date_format(&quot;%Y&quot;), limits = c(as.Date(&quot;1959-01-01&quot;),as.Date(&quot;2023-01-01&quot;))) +
#Bolding plot title and removing legend
  theme(plot.title = element_text(face = &quot;bold&quot;), legend.position = &quot;none&quot;) +
#Creating y-intercept line at 0
  geom_hline(yintercept=0,color=&quot;black&quot;) +
#Creating rugs at bottom of plot
  geom_rug(aes(colour=ifelse(difference &gt;= 0,&quot;steelblue2&quot;,&quot;red&quot;)), sides=&quot;b&quot;,alpha=0.5, position = &quot;jitter&quot;) +
#Plotting the recession grey areas on plot
  geom_rect(data=filter(recessions), inherit.aes=F, aes(xmin=From, xmax=To, ymin=-Inf, ymax=+Inf), fill=&#39;grey&#39;, alpha=0.7) +
#Plotting graph ribbons
  geom_ribbon(aes(ymin = difference, ymax = pmin(difference, 0)), fill= &quot;steelblue2&quot;, alpha=0.5) +
  geom_ribbon(aes(ymin = 0, ymax = pmin(difference, 0)),fill = &quot;red&quot;, alpha=0.5)</code></pre>
<p><img src="homework3_files/figure-html/yield_curve_challenge_plot-1.png" width="100%" style="display: block; margin: auto;" /></p>
</div>
</div>
</div>
<div id="challenge-2gdp-components-over-time-and-among-countries" class="section level1">
<h1>Challenge 2:GDP components over time and among countries</h1>
<p>At the risk of oversimplifying things, the main components of gross domestic product, GDP are personal consumption (C), business investment (I), government spending (G) and net exports (exports - imports). You can read more about GDP and the different approaches in calculating at the <a href="https://en.wikipedia.org/wiki/Gross_domestic_product">Wikipedia GDP page</a>.</p>
<p>The GDP data we will look at is from the <a href="https://unstats.un.org/unsd/snaama/Downloads">United Nations’ National Accounts Main Aggregates Database</a>, which contains estimates of total GDP and its components for all countries from 1970 to today. We will look at how GDP and its components have changed over time, and compare different countries and how much each component contributes to that country’s GDP. The file we will work with is <a href="http://unstats.un.org/unsd/amaapi/api/file/6">GDP and its breakdown at constant 2010 prices in US Dollars</a> and it has already been saved in the Data directory. Have a look at the Excel file to see how it is structured and organised</p>
<pre class="r"><code>UN_GDP_data  &lt;- read_excel(here::here(&quot;data&quot;, &quot;Download-GDPconstant-USD-countries.xls&quot;), # Excel filename
                sheet=&quot;Download-GDPconstant-USD-countr&quot;, # Sheet name
                skip=2) # Number of rows to skip</code></pre>
<p>The first thing you need to do is to tidy the data, as it is in wide format and you must make it into long, tidy format. Please express all figures in billions (divide values by <code>1e9</code>, or <span class="math inline">\(10^9\)</span>), and you want to rename the indicators into something shorter.</p>
<pre class="r"><code>#pivot_longer to transform data from wide format to long
tidy_GDP_data &lt;- UN_GDP_data %&gt;% pivot_longer(-c(CountryID, Country, IndicatorName), #which columns to preserve
                                               values_to = &quot;Value&quot;, #the name of values column
                                               names_to = &quot;year&quot;) %&gt;%  #column with names of previous columns with years
                                 filter(!is.na(Value)) %&gt;% #remain only finite values 
                                 mutate(bln_value = Value/10^9, #divide by 1 bln to get bln values
                                        year = as.numeric(year)) #transform year from chr to numeric
#see columns type of df
glimpse(tidy_GDP_data)</code></pre>
<pre><code>## Rows: 161,459
## Columns: 6
## $ CountryID     &lt;dbl&gt; 4, 4, 4, 4, 4, 4, 4, 4, 4, 4, 4, 4, 4, 4, 4, 4, 4, 4, 4…
## $ Country       &lt;chr&gt; &quot;Afghanistan&quot;, &quot;Afghanistan&quot;, &quot;Afghanistan&quot;, &quot;Afghanist…
## $ IndicatorName &lt;chr&gt; &quot;Final consumption expenditure&quot;, &quot;Final consumption exp…
## $ year          &lt;dbl&gt; 1970, 1971, 1972, 1973, 1974, 1975, 1976, 1977, 1978, 1…
## $ Value         &lt;dbl&gt; 5.56e+09, 5.33e+09, 5.20e+09, 5.75e+09, 6.15e+09, 6.32e…
## $ bln_value     &lt;dbl&gt; 5.56, 5.33, 5.20, 5.75, 6.15, 6.32, 6.37, 6.90, 7.09, 6…</code></pre>
<pre class="r"><code># Let us compare GDP components for these 3 countries
country_list &lt;- c(&quot;United States&quot;,&quot;India&quot;, &quot;Germany&quot;)</code></pre>
<p>First, can you produce this plot?</p>
<p>of course!</p>
<pre class="r"><code>library(car)

options(scipen = 999)
#view photo
knitr::include_graphics(here::here(&quot;images&quot;, &quot;gdp1.png&quot;), error = FALSE)</code></pre>
<p><img src="images/gdp1.png" width="100%" style="display: block; margin: auto;" /></p>
<pre class="r"><code>#recode is used to rename text rows: first argument is the column where we want to change names, then all replacements in rows
tidy_GDP_data$IndicatorName &lt;-  car::recode(tidy_GDP_data$IndicatorName, 
                                       &quot;&#39;Exports of goods and services&#39; = &#39;Exports&#39;;
                                       &#39;Imports of goods and services&#39; = &#39;Imports&#39;;
                                       &#39;General government final consumption expenditure&#39; = &#39;Government expenditure&#39;;
                                       &#39;Household consumption expenditure (including Non-profit institutions serving households)&#39; = &#39;Household expenditure&#39;&quot;)

gdp_components &lt;- c(&quot;Gross capital formation&quot;, &quot;Exports&quot;, &quot;Government expenditure&quot;, &quot;Household expenditure&quot;, &quot;Imports&quot;)

gdp_data_filtered &lt;- tidy_GDP_data %&gt;% 
                      filter(Country %in% country_list &amp; #filter data
                             IndicatorName %in% gdp_components) %&gt;% 
                      mutate(IndicatorName = factor(IndicatorName, levels = gdp_components, #create labels for gdp components
                                                                    labels = gdp_components))
  
ggplot(gdp_data_filtered,
       aes(x = year, y = bln_value, color = IndicatorName)) + #main set up
  geom_line(aes(group = IndicatorName)) + #add lines by indicator names
  facet_wrap(~Country) + #add tiles by country
  scale_x_continuous(breaks = seq(1970, 2020, by = 10)) + #make scale from 1970 to 2020 by step = 10
  theme_bw() + #specify white theme
  labs(title = &quot;GDP Components over time&quot;, #provide names for title, subtitle, x,y
       subtitle = &quot;In constant 2010 USD&quot;,
       x = &quot;&quot;,
       y = &quot;Billion US$&quot;,
       colour = &quot;Components of GDP&quot;) + #change the legend name
  theme(plot.title = element_text(face = &quot;bold&quot;), #make title bold
        panel.grid.minor = element_blank()) #get rid of minor lines in the background</code></pre>
<p><img src="homework3_files/figure-html/gdp1-2.png" width="100%" style="display: block; margin: auto;" /></p>
<p>Secondly, recall that GDP is the sum of Household Expenditure (Consumption <em>C</em>), Gross Capital Formation (business investment <em>I</em>), Government Expenditure (G) and Net Exports (exports - imports). Even though there is an indicator <code>Gross Domestic Product (GDP)</code> in your dataframe, I would like you to calculate it given its components discussed above.</p>
<blockquote>
<p>What is the % difference between what you calculated as GDP and the GDP figure included in the dataframe?</p>
</blockquote>
<pre class="r"><code>gdp_percentage_diff &lt;- tidy_GDP_data %&gt;% 
                       pivot_wider(names_from = IndicatorName, 
                                   values_from = bln_value,
                                   id_cols = c(Country, year)) %&gt;% #transform groups from one column to multiple columns
                       mutate(GDP_calculated = `Gross capital formation` + 
                                               `Exports` + 
                                               `Government expenditure` +
                                               `Household expenditure` - 
                                               `Imports`,
                              GDP_percentage_difference = GDP_calculated / `Gross Domestic Product (GDP)` - 1) %&gt;% 
                      group_by(Country) %&gt;% 
                      filter(!is.na(GDP_percentage_difference)) %&gt;% 
                      summarise(mean_diff = abs(mean(GDP_percentage_difference, na.rm = T) * 100)) %&gt;% 
                      arrange(desc(mean_diff)) #descending sort by mean difference %

gdp_percentage_diff %&gt;% 
  head(n = 25) %&gt;% #select top 25 countries (sorted previously by arrange)
ggplot(aes(y = reorder(Country, mean_diff), #sort countries by mean difference
           x = mean_diff)) +
geom_col(fill = &quot;#00B81F&quot;) +
theme_bw() +
labs(x = &quot;Country&quot;, 
     y = &quot;Absolute mean difference&quot;, 
     title = &quot;Yemen has problems with calculating GDP&quot;,
     subtitle = &quot;Top 25 countries that have the highest mean absolute difference \n between calculated GDP and GDP figure &quot;)</code></pre>
<p><img src="homework3_files/figure-html/perc_diff-1.png" width="100%" style="display: block; margin: auto;" /></p>
<pre class="r"><code>#average mean by all countries
mean(abs(gdp_percentage_diff$mean_diff))</code></pre>
<pre><code>## [1] 3.73</code></pre>
<p>Yemen has the highest percentage difference between calculated GDP and provided GDP in the figure and deviates by 34% from the figure. Moreover, other countries in this list are located either in the islands, in the Middle East or in Africa.</p>
<p>The average absolute mean difference percentage among all countries is 14.22% which is quite high. However, our top-25 contributes a lot to this figure.</p>
<pre class="r"><code>knitr::include_graphics(here::here(&quot;images&quot;, &quot;gdp2.png&quot;), error = FALSE)</code></pre>
<p><img src="images/gdp2.png" width="100%" style="display: block; margin: auto;" /></p>
<pre class="r"><code>gdp_data_filtered2 &lt;- gdp_data_filtered %&gt;% 
                      pivot_wider(names_from = IndicatorName, 
                                  values_from = bln_value,
                                  id_cols = c(Country, year)) %&gt;% 
                      mutate(`Net Exports` = Exports - Imports,
                             Imports = - Imports) %&gt;% #we used 2 mutates because of structure of dplyr: it calcs simultaneously
                      mutate(GDP = rowSums(.[3:7]),
                             `Household expenditure` = `Household expenditure` / GDP,
                             `Government expenditure` = `Government expenditure` / GDP,
                             `Gross capital formation` = `Gross capital formation` / GDP,
                             `Net Exports` = `Net Exports` / GDP) %&gt;% 
                      select(-c(Exports, Imports, GDP)) %&gt;% 
                      pivot_longer(-c(Country, year), #which columns to preserve
                                   values_to = &quot;percentage&quot;, #the name of values column
                                   names_to = &quot;IndicatorName&quot;)

ggplot(gdp_data_filtered2,
       aes(x = year, y = percentage, color = IndicatorName)) + #main set up
  geom_line(aes(group = IndicatorName)) + #add lines by indicator names
  facet_wrap(~Country) + #add tiles by country
  scale_x_continuous(breaks = seq(1970, 2020, by = 10)) + #make scale from 1970 to 2020 by step = 10
  theme_bw() + #specify white theme
  labs(title = &quot;GDP and its breakdown at constant 2010 prices in US Dollars&quot;, #provide names for title, subtitle, x,y
       caption = &quot;Source: United Nations, https://unstats.un.org/unsd/snaama/Downloads&quot;,
       x = &quot;&quot;,
       y = &quot;proportion&quot;,
       colour = &quot;&quot;) + #change the legend name
  theme(panel.grid.minor = element_blank()) #get rid of minor lines in the background</code></pre>
<p><img src="homework3_files/figure-html/gdp2-2.png" width="100%" style="display: block; margin: auto;" /></p>
<blockquote>
<p>What is this last chart telling you? Can you explain in a couple of paragraphs the different dynamic among these three countries?</p>
</blockquote>
<p>First of all, Germany and United States are developed countries which means that they should have similar patterns but some components of GDP demonstrate otherwise, while India is an emerging country. In our developed countries investment and government components of GDP intersected several times while in India there was a huge difference between them in 1970s and has increased during the 50-year period. The investment share in both developed countries is at the same level - 20% of total GDP - while in India it has almost doubled during the period.</p>
<p>Household expenditure in Germany and India has decreased during the discussed period but in America there was a reverse situation - consumer spending proportion has risen. Furthermore, household expenditure is still the largest part of GDP in all three countries.</p>
<p>Also, it is very interesting to consider Net exports proportion. India and USA has the similar movement pattern in this component: it moves in one direction in both countries and also is negative which means that imports outweigh exports. In Germany net exports proportion was around 0% but since 2000 it has increased almost to 10% of GDP.</p>
<blockquote>
<p>If you want to, please change <code>country_list &lt;- c("United States","India", "Germany")</code> to include your own country and compare it with any two other countries you like</p>
</blockquote>
<pre class="r"><code>library(gridExtra)
#I would like to speculate this task and advance further. 
#I will create a function that can draw the graph with any countries I would like to compare.

UN_GDP_data  &lt;- read_excel(here::here(&quot;data&quot;, &quot;Download-GDPconstant-USD-countries.xls&quot;), # Excel filename
                sheet=&quot;Download-GDPconstant-USD-countr&quot;, # Sheet name
                skip=2) # Number of rows to skip

# create a function where you plug in 
compare_countries_by_gdp &lt;- function(UN_GDP_data, country_list) {
  

#pivot_longer to transform data from wide format to long
tidy_GDP_data &lt;- UN_GDP_data %&gt;% pivot_longer(-c(CountryID, Country, IndicatorName), #which columns to preserve
                                               values_to = &quot;Value&quot;, #the name of values column
                                               names_to = &quot;year&quot;) %&gt;%  #column with names of previous columns with years
                                 filter(!is.na(Value)) %&gt;% #remain only finite values 
                                 mutate(bln_value = Value/10^9, #divide by 1 bln to get bln values
                                        year = as.numeric(year)) #transform year from chr to numeric

  #recode is used to rename text rows: first argument is the column where we want to change names, then all replacements in rows
tidy_GDP_data$IndicatorName &lt;-  car::recode(tidy_GDP_data$IndicatorName, 
                                       &quot;&#39;Exports of goods and services&#39; = &#39;Exports&#39;;
                                       &#39;Imports of goods and services&#39; = &#39;Imports&#39;;
                                       &#39;General government final consumption expenditure&#39; = &#39;Government expenditure&#39;;
                                       &#39;Household consumption expenditure (including Non-profit institutions serving households)&#39; = &#39;Household expenditure&#39;&quot;)

gdp_components &lt;- c(&quot;Gross capital formation&quot;, &quot;Exports&quot;, &quot;Government expenditure&quot;, &quot;Household expenditure&quot;, &quot;Imports&quot;)

gdp_data_filtered &lt;- tidy_GDP_data %&gt;% 
                      filter(Country %in% country_list &amp; #filter data
                             IndicatorName %in% gdp_components) %&gt;% 
                      mutate(IndicatorName = factor(IndicatorName, levels = gdp_components, #create labels for gdp components
                                                                    labels = gdp_components))
gdp_value &lt;- ggplot(gdp_data_filtered,
                   aes(x = year, y = bln_value, color = IndicatorName)) + #main set up
              geom_line(aes(group = IndicatorName)) + #add lines by indicator names
              facet_wrap(~Country) + #add tiles by country
              scale_x_continuous(breaks = seq(1970, 2020, by = 10)) + #make scale from 1970 to 2020 by step = 10
              theme_bw() + #specify white theme
              labs(title = &quot;GDP Components over time&quot;, #provide names for title, subtitle, x,y
                   subtitle = &quot;In constant 2010 USD&quot;,
                   x = &quot;&quot;,
                   y = &quot;Billion US$&quot;,
                   colour = &quot;Components of GDP&quot;) + #change the legend name
              theme(plot.title = element_text(face = &quot;bold&quot;), #make title bold
                    panel.grid.minor = element_blank()) #get rid of minor lines in the background



gdp_data_filtered2 &lt;- gdp_data_filtered %&gt;% 
                      pivot_wider(names_from = IndicatorName, 
                                  values_from = bln_value,
                                  id_cols = c(Country, year)) %&gt;% 
                      mutate(`Net Exports` = Exports - Imports,
                             Imports = - Imports) %&gt;% #we used 2 mutates because of structure of dplyr: it calcs simultaneously
                      mutate(GDP = rowSums(.[3:7]),
                             `Household expenditure` = `Household expenditure` / GDP,
                             `Government expenditure` = `Government expenditure` / GDP,
                             `Gross capital formation` = `Gross capital formation` / GDP,
                             `Net Exports` = `Net Exports` / GDP) %&gt;% 
                      select(-c(Exports, Imports, GDP)) %&gt;% 
                      pivot_longer(-c(Country, year), #which columns to preserve
                                   values_to = &quot;percentage&quot;, #the name of values column
                                   names_to = &quot;IndicatorName&quot;)

gdp_prop &lt;- ggplot(gdp_data_filtered2,
                   aes(x = year, y = percentage, color = IndicatorName)) + #main set up
              geom_line(aes(group = IndicatorName)) + #add lines by indicator names
              facet_wrap(~Country) + #add tiles by country
              scale_x_continuous(breaks = seq(1970, 2020, by = 10)) + #make scale from 1970 to 2020 by step = 10
              theme_bw() + #specify white theme
              labs(title = &quot;GDP and its breakdown at constant 2010 prices in US Dollars&quot;, #provide names for title, subtitle, x,y
                   caption = &quot;Source: United Nations, https://unstats.un.org/unsd/snaama/Downloads&quot;,
                   x = &quot;&quot;,
                   y = &quot;proportion&quot;,
                   colour = &quot;&quot;) + #change the legend name
              theme(panel.grid.minor = element_blank()) #get rid of minor lines in the background


return(grid.arrange(gdp_value, gdp_prop, nrow = 2))
}

country_list &lt;- c(&quot;Russian Federation&quot;, &quot;France&quot;, &quot;Greece&quot;, &quot;Germany&quot;)
compare_countries_by_gdp(UN_GDP_data, country_list)</code></pre>
<p><img src="homework3_files/figure-html/gdp_general-1.png" width="100%" style="display: block; margin: auto;" /></p>
<pre class="r"><code># As an overall, we would like to thank you for an opportunity to learn and improve our knowledge in R. 
# Tasks were really challenging (at some point of time we wish it was not SO challenging) 
# and interesting to learn. Thank you!</code></pre>
</div>
<div id="deliverables" class="section level1">
<h1>Deliverables</h1>
<p>There is a lot of explanatory text, comments, etc. You do not need these, so delete them and produce a stand-alone document that you could share with someone. Knit the edited and completed R Markdown file as an HTML document (use the “Knit” button at the top of the script editor window) and upload it to Canvas.</p>
</div>
<div id="details" class="section level1">
<h1>Details</h1>
<ul>
<li>Who did you collaborate with: TYPE NAMES HERE</li>
<li>Approximately how much time did you spend on this problem set: ANSWER HERE</li>
<li>What, if anything, gave you the most trouble: ANSWER HERE</li>
</ul>
<p><strong>Please seek out help when you need it,</strong> and remember the <a href="https://mfa2021.netlify.app/syllabus/#the-15-minute-rule" target="_blank">15-minute rule</a>. You know enough R (and have enough examples of code from class, your previous homeworks, and your readings) to be able to do this. If you get stuck, ask for help from others, post a question on Slack– and remember that I am here to help too!</p>
<blockquote>
<p>As a true test to yourself, do you understand the code you submitted and are you able to explain it to someone else?</p>
</blockquote>
</div>
<div id="rubric" class="section level1">
<h1>Rubric</h1>
<p>Check minus (1/5): Displays minimal effort. Doesn’t complete all components. Code is poorly written and not documented. Uses the same type of plot for each graph, or doesn’t use plots appropriate for the variables being analyzed.</p>
<p>Check (3/5): Solid effort. Hits all the elements. No clear mistakes. Easy to follow (both the code and the output).</p>
<p>Check plus (5/5): Finished all components of the assignment correctly and addressed both challenges. Code is well-documented (both self-documented and with additional comments as necessary). Used tidyverse, instead of base R. Graphs and tables are properly labelled. Analysis is clear and easy to follow, either because graphs are labeled clearly or you’ve written additional text to describe how you interpret the output.</p>
</div>
